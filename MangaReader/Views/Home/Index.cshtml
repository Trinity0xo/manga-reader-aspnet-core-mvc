@model HomeContentViewModel
@using MangaReader.Utils
@using MangaReader.ViewModels

@{
    ViewData["Title"] = "Trang chủ";
    var coversFolder = ViewBag.CoversFolder as string;
    var mangasFolder = ViewBag.MangasFolder as string;
    var basePath = ViewBag.BasePath as string;
}

@if(Model.NewestMangas.Count() > 0)
{
    <section class="mb-3 d-flex flex-column gap-3">
        <h3 class="m-0">Truyện mới</h3>
        <div id="newestMangasCarousel" class="carousel slide card rounded-0 shadow-sm" data-bs-ride="carousel">
                <div class="carousel-inner">
                    @{
                        int index = 0;
                    }
                    @foreach (var item in Model.NewestMangas)
                    {
                        <div class="carousel-item @(index == 0 ? "active" : "")">
                            <div class="manga">
                                <div class="manga-cover">
                                    <img src="@($"/{basePath}/{mangasFolder}/{item.Slug}/{coversFolder}/{item.Cover}")"
                                         alt="@item.Cover" />
                                </div>
                                <div class="manga-info">
                                    <h2 class="manga-title">
                                    <a asp-controller="Mangas" asp-action="Details" asp-route-mangaSlug="@item.Slug" asp-route-mangaId="@item.Id"
                                           class="text-decoration-none link-dark">
                                            @item.Title
                                        </a>
                                    </h2>
                                    @if (item.Genres.Count > 0)
                                    {
                                        <div class="manga-genres d-none d-md-flex flex-wrap gap-2">
                                            @foreach (var genre in item.Genres)
                                            {
                                                <a asp-controller="Mangas" asp-action="Index"
                                                   asp-route-Genres="@genre.Slug"
                                                   class="badge bg-secondary text-decoration-none link-light">
                                                    @genre.Name
                                                </a>
                                            }
                                        </div>
                                    }
                                    <p class="manga-description">@item.Description</p>
                                </div>
                            </div>
                            @if (item.Genres.Count > 0)
                            {
                                <div class="manga-genres mt-2 d-flex d-md-none flex-wrap gap-2">
                                    @foreach (var genre in item.Genres)
                                    {
                                    <a asp-controller="Mangas" asp-action="Index"
                                           asp-route-Genres="@genre.Slug"
                                           class="badge bg-secondary text-decoration-none link-light">
                                            @genre.Name
                                        </a>
                                    }
                                </div>
                            }
                        </div>
                        index++;
                    }
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#newestMangasCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#newestMangasCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
 
    </section>
}

@if (Model.NewestChapterMangas.Count() > 0)
{
    <section class="mb-3 d-flex flex-column gap-3">
        <div class="d-flex justify-content-between flex-wrap">
            <h3 class="m-0">Chương mới</h3>
            <a asp-controller="Mangas" asp-action="NewestChapter" class="btn btn-primary">Tất cả</a>
        </div>
        <div class="row g-4">
            @foreach (var item in Model.NewestChapterMangas)
            {
                <div class="col-md-6">
                    <a asp-controller="Chapters" asp-action="Details" asp-route-chapterSlug="@item.Chapters.First().Slug" asp-route-chapterId="@item.Chapters.First().Id" class="card rounded-0 shadow-sm flex-row gap-3 p-2 text-decoration-none">
                        <div class="manga-cover" style="width: 80px">
                            <img src="@($"/{basePath}/{mangasFolder}/{item.Slug}/{coversFolder}/{item.Cover}")" alt="@item.Cover" />
                        </div>
                        
                        <div class="d-flex flex-column flex-grow-1 gap-1" style="min-width: 0">
                            <h5 class="m-0 text-truncate text-dark">@item.Title</h5>
                            <p class="m-0 text-truncate text-dark">@item.Chapters.First().Title</p>
                            <div class="d-flex justify-content-end mt-auto">
                                <p class="m-0 text-muted">@DateTimeUtils.TimeAgo(item.CreatedAt)</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </section>
}

@if (Model.MostViewdMangas.Count() > 0)
{
    <section class="mb-3 d-flex flex-column gap-3">
        <div class="d-flex justify-content-between flex-wrap">
            <h3 class="m-0">Xem nhiều</h3>
            <a asp-controller="Mangas" asp-action="MostViewed" class="btn btn-primary">Tất cả</a>
        </div>
        <div id="mostViewedMangasCarousel" class="carousel">
            <div class="carousel-inner">
                @foreach (var item in Model.MostViewdMangas)
                {
                    <div class="carousel-item">
                        <a asp-controller="Mangas" asp-action="Details" asp-route-mangaSlug="@item.Slug" asp-route-mangaId="@item.Id" class="manga-card card rounded-0 shadow-sm text-decoration-none">
                            <div class="manga-cover mb-2">
                                <img src="@($"/{basePath}/{mangasFolder}/{item.Slug}/{coversFolder}/{item.Cover}")"
                                     alt="@item.Cover" />
                            </div>

                            <h5 class="m-0 text-truncate text-dark">@item.Title</h5>
                        </a>
                    </div>
                }
            </div>
            <button class="carousel-control-prev" type="button" id="mostViewedMangasCarouselPrevBtn">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" id="mostViewedMangasCarouselNextBtn">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </section>
}

@if (Model.MostFollowedManga.Count() > 0)
{
    <section class="d-flex flex-column gap-3">
        <div class="d-flex justify-content-between flex-wrap">
            <h3 class="m-0">Theo dõi nhiều</h3>
            <a asp-controller="Mangas" asp-action="MostFollowed" class="btn btn-primary">Tất cả</a>
        </div>
        <div id="mostFollowedMangasCarousel" class="carousel">
            <div class="carousel-inner">
                @foreach (var item in Model.MostFollowedManga)
                {
                    <div class="carousel-item">
                        <a asp-controller="Mangas" asp-action="Details" asp-route-mangaSlug="@item.Slug" asp-route-mangaId="@item.Id" class="manga-card card rounded-0 shadow-sm text-decoration-none">
                            <div class="manga-cover mb-2">
                                <img src="@($"/{basePath}/{mangasFolder}/{item.Slug}/{coversFolder}/{item.Cover}")"
                                      alt="@item.Cover" />
                            </div>
                           
 
                            <h5 class="m-0 text-truncate text-dark">@item.Title</h5>
                        </a>
                    </div>
                }
            </div>
            <button class="carousel-control-prev" type="button" id="mostFollowedMangasCarouselPrevBtn">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" id="mostFollowedMangasCarouselNextBtn">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </section>
}

@section Scripts {
    <script>
        /*custom viewed mangas carousel*/
        const $mostViewedMangasCarouselInner = $("#mostViewedMangasCarousel .carousel-inner");
        let mostViewedMangasCarouselInnerWidth = $mostViewedMangasCarouselInner[0].scrollWidth;
        let mostViewedMangasCarouselItemWidth = $("#mostViewedMangasCarousel .carousel-inner .carousel-item").width();
        let totalMostViewedMangasCarouselItemWidth = 0;

        function updateMostViewedConfig() {
            mostViewedMangasCarouselInnerWidth = $mostViewedMangasCarouselInner[0].scrollWidth;
            mostViewedMangasCarouselItemWidth = $("#mostViewedMangasCarousel .carousel-inner .carousel-item").width();

            const screenWidth = window.innerWidth;
            if (screenWidth <= 576) totalMostViewedMangasCarouselItemWidth = mostViewedMangasCarouselItemWidth * 1;
            else if (screenWidth <= 768) totalMostViewedMangasCarouselItemWidth = mostViewedMangasCarouselItemWidth * 2;
            else if (screenWidth <= 992) totalMostViewedMangasCarouselItemWidth = mostViewedMangasCarouselItemWidth * 3;
            else totalMostViewedMangasCarouselItemWidth = mostViewedMangasCarouselItemWidth * 4;
        }

        updateMostViewedConfig();
        $(window).on("resize", updateMostViewedConfig);

        let mostViewedScrollPos = 0;
        const $mostViewedPrevBtn = $("#mostViewedMangasCarouselPrevBtn");
        const $mostViewedNextBtn = $("#mostViewedMangasCarouselNextBtn");

        $mostViewedNextBtn.on("click", function () {
            if (mostViewedScrollPos < (mostViewedMangasCarouselInnerWidth - totalMostViewedMangasCarouselItemWidth)) {
                mostViewedScrollPos += mostViewedMangasCarouselItemWidth;
                $mostViewedMangasCarouselInner.animate({ scrollLeft: mostViewedScrollPos }, 600);
            }
        });
        $mostViewedPrevBtn.on("click", function () {
            if (mostViewedScrollPos > 0) {
                mostViewedScrollPos -= mostViewedMangasCarouselItemWidth;
                $mostViewedMangasCarouselInner.animate({ scrollLeft: mostViewedScrollPos }, 600);
            }
        });

        /*custom followed mangas carousel*/
        const $mostFollowedMangasCarouselInner = $("#mostFollowedMangasCarousel .carousel-inner");
        let mostFollowedMangasCarouselInnerWidth = $mostFollowedMangasCarouselInner[0].scrollWidth;
        let mostFollowedMangasCarouselItemWidth = $("#mostFollowedMangasCarousel .carousel-inner .carousel-item").width();
        let totalMostFollowedMangasCarouselItemWidth = 0;

        function updateMostFollowedConfig() {
            mostFollowedMangasCarouselInnerWidth = $mostFollowedMangasCarouselInner[0].scrollWidth;
            mostFollowedMangasCarouselItemWidth = $("#mostFollowedMangasCarousel .carousel-inner .carousel-item").width();

            const screenWidth = window.innerWidth;
            if (screenWidth < 576) {
                totalMostFollowedMangasCarouselItemWidth = mostFollowedMangasCarouselItemWidth * 1;
            } else if (screenWidth < 768) {
                totalMostFollowedMangasCarouselItemWidth = mostFollowedMangasCarouselItemWidth * 2;
            } else if (screenWidth < 992) {
                totalMostFollowedMangasCarouselItemWidth = mostFollowedMangasCarouselItemWidth * 3;
            } else {
                totalMostFollowedMangasCarouselItemWidth = mostFollowedMangasCarouselItemWidth * 4;
            }
        }

        updateMostFollowedConfig();
        $(window).on("resize", updateMostFollowedConfig);

        let mostFollowedScrollPos = 0;
        const $mostFollowedPrevBtn = $("#mostFollowedMangasCarouselPrevBtn");
        const $mostFollowedNextBtn = $("#mostFollowedMangasCarouselNextBtn");

        $mostFollowedNextBtn.on("click", function () {
            console.log($mostFollowedMangasCarouselInner[0].scrollWidth);
            console.log($mostFollowedMangasCarouselInner[0].clientWidth);
            console.log("Item width:", mostFollowedMangasCarouselItemWidth);
            console.log("Total width:", mostFollowedMangasCarouselInnerWidth);
            if (mostFollowedScrollPos < (mostFollowedMangasCarouselInnerWidth - totalMostFollowedMangasCarouselItemWidth)) {
                mostFollowedScrollPos += mostFollowedMangasCarouselItemWidth;
                $mostFollowedMangasCarouselInner.animate({ scrollLeft: mostFollowedScrollPos }, 600);
            }
        });
        $mostFollowedPrevBtn.on("click", function () {
            if (mostFollowedScrollPos > 0) {
                mostFollowedScrollPos -= mostFollowedMangasCarouselItemWidth;
                $mostFollowedMangasCarouselInner.animate({ scrollLeft: mostFollowedScrollPos }, 600);
            }
        });
    </script>
}
